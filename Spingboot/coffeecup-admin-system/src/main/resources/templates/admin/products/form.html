<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${pageTitle}">Product Form - CoffeeCup Admin</title>
    <link rel="stylesheet" th:href="@{/css/admin-style.css}">
    <style>
        .live-error { color: #dc3545; font-size: 0.8em; display: none; margin-top: 4px; }
        .form-control.is-invalid-js { border-color: #dc3545; }
        .form-control.is-invalid-js + .live-error { display: block; }
        .form-control.is-invalid { border-color: #dc3545; }
        .invalid-feedback { display: block; width: 100%; margin-top: 4px; font-size: 80%; color: #dc3545; }
        .form-error-message { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; padding: .75rem 1.25rem; margin-bottom: 1rem; border: 1px solid transparent; border-radius: .25rem; }
        textarea.form-control { height: auto; min-height: 100px; }
        .current-image { max-width: 150px; height: auto; display: block; margin-top: 10px; border: 1px solid #ddd; padding: 5px; }
    </style>
</head>
<body>
<div class="container">
    <h1 th:text="${pageTitle}">Product Form</h1>

    <div th:if="${saveError}" class="form-error-message" th:text="${saveError}"></div>

    <form id="productForm" th:action="@{/admin/products/save}" th:object="${product}" method="post" enctype="multipart/form-data" novalidate>
        <input type="hidden" th:field="*{ma}" />
        <input type="hidden" th:field="*{imageFileName}" />

        <!-- Name (Ten) Input -->
        <div class="form-group">
            <label for="ten">Product Name:</label>
            <input type="text" id="ten" th:field="*{ten}"
                   th:class="'form-control' + (${#fields.hasErrors('ten')} ? ' is-invalid' : '')"
                   required maxlength="255" aria-describedby="tenError serverTenError"/>
            <span id="tenError" class="live-error">Product name cannot be empty.</span>
            <div id="serverTenError" th:if="${#fields.hasErrors('ten')}" class="invalid-feedback">
                <span th:errors="*{ten}"></span>
            </div>
        </div>

        <!-- Description (MoTa) Input -->
        <div class="form-group">
            <label for="moTa">Description:</label>
            <textarea id="moTa" th:field="*{moTa}" rows="3"
                      th:class="'form-control' + (${#fields.hasErrors('moTa')} ? ' is-invalid' : '')"
                      maxlength="500" aria-describedby="moTaError serverMoTaError"></textarea>
            <span id="moTaError" class="live-error">Description cannot exceed 500 characters.</span>
            <div id="serverMoTaError" th:if="${#fields.hasErrors('moTa')}" class="invalid-feedback">
                <span th:errors="*{moTa}"></span>
            </div>
        </div>

        <!-- Content (NoiDung) Input -->
        <div class="form-group">
            <label for="noiDung">Content:</label>
            <textarea id="noiDung" th:field="*{noiDung}" rows="6"
                      th:class="'form-control' + (${#fields.hasErrors('noiDung')} ? ' is-invalid' : '')"
                      aria-describedby="noiDungError serverNoiDungError"></textarea>
            <span id="noiDungError" class="live-error">Error in content.</span>
            <div id="serverNoiDungError" th:if="${#fields.hasErrors('noiDung')}" class="invalid-feedback">
                <span th:errors="*{noiDung}"></span>
            </div>
        </div>

        <!-- Price (Gia) Input -->
        <div class="form-group">
            <label for="gia">Price:</label>
            <input type="number" id="gia" th:field="*{gia}" step="0.01" min="0.01"
                   th:class="'form-control' + (${#fields.hasErrors('gia')} ? ' is-invalid' : '')"
                   required aria-describedby="giaError serverGiaError"/>
            <span id="giaError" class="live-error">Price must be a positive number (e.g., 10.50).</span>
            <div id="serverGiaError" th:if="${#fields.hasErrors('gia')}" class="invalid-feedback">
                <span th:errors="*{gia}"></span>
            </div>
        </div>

        <!-- Upload Image -->
        <div class="form-group">
            <label for="imageFile">Product Image:</label>
            <input type="file" id="imageFile" name="imageFile" class="form-control" accept="image/png, image/jpeg, image/gif"/>
            <div th:if="${product.ma != null and product.imageFileName != null}">
                <label style="margin-top: 10px; font-weight: normal;">Current Image:</label>
                <img th:src="@{${product.getImageUrl()}}" alt="Current Product Image" class="current-image"/>
            </div>
        </div>

        <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" />

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save Product</button>
            <a th:href="@{/admin/products}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
    const tenInput = document.getElementById('ten');
    const tenError = document.getElementById('tenError');
    const moTaInput = document.getElementById('moTa');
    const moTaError = document.getElementById('moTaError');
    const noiDungInput = document.getElementById('noiDung');
    const noiDungError = document.getElementById('noiDungError');
    const giaInput = document.getElementById('gia');
    const giaError = document.getElementById('giaError');
    const serverTenErrorDiv = document.getElementById('serverTenError');
    const serverMoTaErrorDiv = document.getElementById('serverMoTaError');
    const serverNoiDungErrorDiv = document.getElementById('serverNoiDungError');
    const serverGiaErrorDiv = document.getElementById('serverGiaError');

    function validateProductInput(inputElement, errorElement, serverErrorDiv) {
        inputElement.classList.remove('is-invalid');
        inputElement.classList.remove('is-invalid-js');
        errorElement.style.display = 'none';
        if (serverErrorDiv) serverErrorDiv.style.display = 'none';

        if (!inputElement.checkValidity()) {
            inputElement.classList.add('is-invalid-js');
            let message = 'Invalid input.';
            const validity = inputElement.validity;

            if (validity.valueMissing) {
                let fieldName = inputElement.labels[0]?.textContent.replace(':','').trim() || inputElement.id;
                message = `${fieldName} cannot be empty.`;
            } else if (validity.rangeUnderflow || validity.rangeOverflow || validity.stepMismatch || validity.badInput) {
                if(inputElement.id === 'gia') message = giaError.textContent;
                else message = 'Invalid number format or value.';
            } else if (validity.tooLong) {
                message = `Cannot exceed ${inputElement.maxLength} characters.`;
            }

            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
    }

    tenInput.addEventListener('input', () => validateProductInput(tenInput, tenError, serverTenErrorDiv));
    tenInput.addEventListener('blur', () => validateProductInput(tenInput, tenError, serverTenErrorDiv));
    moTaInput.addEventListener('input', () => validateProductInput(moTaInput, moTaError, serverMoTaErrorDiv));
    giaInput.addEventListener('input', () => validateProductInput(giaInput, giaError, serverGiaErrorDiv));
    giaInput.addEventListener('blur', () => validateProductInput(giaInput, giaError, serverGiaErrorDiv));
    noiDungInput.addEventListener('input', () => validateProductInput(noiDungInput, noiDungError, serverNoiDungErrorDiv));

    const imageFileInput = document.getElementById('imageFile');
    imageFileInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            const allowedTypes = ['image/png', 'image/jpeg', 'image/gif'];
            const maxSizeMB = 5;
            const maxSizeBytes = maxSizeMB * 1024 * 1024;

            if (!allowedTypes.includes(file.type)) {
                alert('Invalid file type. Please select a PNG, JPEG, or GIF image.');
                this.value = '';
            } else if (file.size > maxSizeBytes) {
                alert(`File is too large. Maximum size is ${maxSizeMB}MB.`);
                this.value = '';
            }
        }
    });

    const form = document.getElementById('productForm');
    form.addEventListener('submit', function (event) {
        let isFormValid = true;
        validateProductInput(tenInput, tenError, serverTenErrorDiv);
        if (!tenInput.checkValidity()) isFormValid = false;

        validateProductInput(moTaInput, moTaError, serverMoTaErrorDiv);
        if (!moTaInput.checkValidity()) isFormValid = false;

        validateProductInput(noiDungInput, noiDungError, serverNoiDungErrorDiv);

        validateProductInput(giaInput, giaError, serverGiaErrorDiv);
        if (!giaInput.checkValidity()) isFormValid = false;

        if (!isFormValid) {
            event.preventDefault();
            event.stopPropagation();
            alert('Please fix the client-side validation errors before submitting.');
        }
    }, false);
</script>
</body>
</html>